var pakkumised = require('../lib/pakkumised.js')
    , should = require('chai').should()
    , cheerio = require('cheerio')
    , fs = require('fs')
    , _ = require('underscore')._
    , sanitizer = require('sanitizer')

describe('Pakkumised initialization', function () {

    it('should return valid object containing all functions', function () {
        pakkumised.should.be.an('object')
        pakkumised.should.have.property('parse')
        pakkumised.should.have.property('repositories')
        pakkumised.parse.should.be.an('function')
    })

    beforeEach(function () {

    })

    var validator = function (site, params, skip) {
        if (skip) {
            console.log('skipping ' + site + '...')
            return
        }

        describe('validating' + site, function () {
            var parsed = pakkumised.parse(cheerio.load(fs.readFileSync(__dirname + '/data/' + site + '.html', 'utf8') + ''), site);
            it('should be object', function () {
                parsed.should.be.an('object')
            })

            it('should contain pictures', function () {
                parsed.should.have.property('pictures')

                it ('should contain main pictures', function() {
                    parsed.pictures.should.have.property('main')
                    parsed.pictures.main.length.should.equal(params.pictures.main.count)

                    for (var i = 0; i < parsed.pictures.main.length; i++) {
                        parsed.pictures.main[i].should.equal(params.pictures.main[i])
                    }
                })

                it ('should contain other pictures', function() {
                    parsed.pictures.should.have.property('other')
                    parsed.pictures.other.length.should.equal(params.pictures.other.length)

                    for (var i = 0; i < parsed.pictures.other.length; i++) {
                        parsed.pictures.other[i].should.equal(params.pictures.other[i])
                    }
                })
            })

            it('should contain price information', function () {
                parsed.should.have.property('price')
                parsed.price.should.have.property('discount')
                parsed.price.discount.should.equal(params.price.discount)
                parsed.price.should.have.property('regular')
                parsed.price.regular.should.equal(params.price.regular)
                parsed.price.should.have.property('percent')
                parsed.price.percent.should.equal(params.price.percent)
                parsed.price.should.have.property('benefit')
                parsed.price.benefit.should.equal(params.price.benefit)
            })

            it('should contain title', function () {
                parsed.should.have.property('title')
                parsed.title.should.have.property('full')
                parsed.title.full.should.equal(params.title.full)
                parsed.title.should.have.property('short')
                parsed.title.short.should.equal(params.title.short)
            })

            it('should contain seller\'s information', function () {
                parsed.should.have.property('seller')
                parsed.seller.should.have.property('info')
                sanitizer.sanitize(parsed.seller.info).replace(/ +(?= )/g,'').should.equal(params.seller.info)
            })

            it('should contain description', function () {
                parsed.should.have.property('description')
                parsed.description.should.have.property('full')
                parsed.description.full.should.equal(params.description.full)
                parsed.description.should.have.property('short')
                parsed.description.short.should.equal(params.description.short)
                parsed.description.should.have.property('map')
                parsed.description.map.should.equal(params.description.map)
            })
        })
    }

    validator('www.zizu.ee', {
        'pictures':{
            'main':[
                '/sites/default/files/thayland_100912_main.jpg'],
            'other':[
                'http://zizu.ee/sites/default/files/dattach/tai0911/thayland_100912_bottom.jpg']
        }, "price":{
            "discount":"219 €"
            , "regular":"618 €"
            , "percent":"65"
            , "benefit":""
        }, "title":{
            "full":"Kuum puhkus kahele Tais vaid 219 €. Nädal eksootikat Pattayas Deluxe toas hommikusöökidega!"
            , "short":""
        }, "seller":{
            "info":'<p> <b>Aadress: </b>“Rattana Suk Inn”, 115/1 Pattaya-Nakluar Road, T. Nakluar, A.Banglamuang, Chonburi 20250, Thailand</p> <p><b>Telefon: </b>+66 (0) 3842 0585, +66 (0) 3842 8267, +66 (0) 3842 8485</p> <p><b>e-mail: </b>lantanapattaya@gmail.com</p> <p><b>Tööaeg: </b>Iga päev <br>Check-in alates 14:00 <br>Check-out kuni 12:00 </p>'
        }, "description": {
            "full":'<h3 class="conditions">Tingimused</h3> <ul><li>Soe kliima ja merevesi, eksootilised elamused, hunnitud liivarannad, taskukohased hinnad ja lugematud vaba aja veetmise võimalused. See kõik ootab Teid Tais Pattayas - Kagu-Aasia tuntuimas rannakuurordis, mis paikneb Bangkoki lahe idakaldal Bangokist ~150 km kaugusel </li><br/><li>Kupong on <b style="color:#78A918;">kahele külalisele</b> ja sisaldab majutust (8 päeva / 7 ööd) eksootilises Tais hotellis <b style="color:#78A918;">Lantana Pattaya Hotel & Resort deluxe klassi toas koos hommikusöökidega</b> </li><br/><li>Oivalise asukohaga ja peresõbralikus Lantana Pattaya Hotel & Resort hotellis on aed, välibassein ja lastebassein, kiire wifi, restoran, basseiniäärne baar ja parkla </li><br/><li>Hotelli 60 mugavat tuba on kliimaseadmega ja rõdudega vaatega merele, linnale või aiale. Voodites on mäluvaht madratsid ja esmaklassiline voodipesu. Lisatasu eest toas kiire wifi. Telerites on kaabel-tv-kanalid, tasuta filmikanalid ja DVD-mängijad. Vannitubades on dušid, föönid ja tasuta tualett-tarbed. Tubades on külmikud ja pudelivesi </li><br/><li>Kupong sisaldab majutust ja lennupiletid kupongis ei sisaldu </li><br/><li><b>Lapsed ja lisavoodid:</b> <br/>- maksimaalselt mahub tuppa 3 inimest <br/>- 0-12 aastane laps saab samas toas olemasolevatel vooditel ööbida tasuta, lisandub hommikusöögi maksumus 80 (~ 2 €) Tai baati/hommikusöök <br/>- lisavoodi (12+ aastastele) maksab 650 Tai baati/öö (~16,4 €), sisaldab hommikusööki </li><br/><li>Tubasid saab broneerimida alates 21. september 2012 </li><br/><li><b>Lisakulud:</b> Kupong kehtib 21.09.2012 – 31.07.2013, kuid ajavahemikul 16. detsember 2012 - 15. jaanuar 2013 (mõlemad kuupäevad kaasa arvatud) lisandub kõrghooaja lisatasu 2500 Tai baati (~ 63 €) iga hotellis viibitud öö kohta. Ülejäänud kupongi kehtivusperioodil täiendavaid lisatasusid ei lisandu </li></ul> <ul><li>Kupong kehtib alates R, 21/09/2012 - 14:00 kuni K, 31/07/2013 - 12:00</li></ul>'
            , "short":'<h3 class="conditions">Eripärad</h3> <ul> <li><b style="color:#78A918;">Zizu reisisoovitus: </b> <br/>Lantana Pattaya Hotel & Resort paikneb Pattayas Naklua Roadil, mis on linna üks oivalisemaid asukohtadest. Lähim rand on 700m jalutuskäigu kaugusel, 10-minutilise autosõidu kaugusel on Golden Beach Pattaya (peamine rand), Big-C Kaubamaja ja Lotus SuperCenter ja hotelli lähedal on meelelahutuskeskused. Hotellile on lihtne ja mugav ligipääs ühistranspordiga. Lantana Pattaya Hotel & Resort pakub kõrgetasemelisi majutust. <br/><br/>Pattaya randades saab sõita veesuuskade ja skuutriga, sukelduda, purjetada, surfata ja langevarjuga lennata. Pattayas on võimalik mängida golfi, tennist, squashi, paintballi ja bowlingut, ratsutada ja kardiga sõita. Ekskursioonidel saab käia elevandikülades, liblikapargis, tiigriloomaaias ja krokodillifarmis. Kuulsad on ka täiskasvanutele mõeldud Alcazari ja Tiffany transvestiitide kabareed. Nong Nooch\'i orhideepargis on erinevad eksootilised lilled ja taimed </li><br/><li><b style="color:#78A918;">Hea teada: </b> <br/>Antud hotellis antud perioodil on keskmine toa hind kahele 88, 30 €/öö ja 618 € nädal. Kupong maksab 219 € ja Teie sääst on 399 €</li> </ul> <h3 class="information">Lisainfo</h3> <p class="rtecenter"> <img alt="" src="http://zizu.ee/sites/default/files/dattach/tai0911/thayland_100912_bottom.jpg" width="640"/> </p>'
            , "map":""
        }
    })

    validator('www.super24.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.seiklused.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.ostulaine.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.osta.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.niihea.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.mylook.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.minuvalik.ee', {
        'pictures':{
            'main':[
                '/banners/actions/4151975663/ee_dd.gif']
            , 'other':[
                    '/actions/astra/02092010_1.jpg',
                    '/banners/actions/1306374683/2.jpg',
                    '/actions/astra/02092010_3.jpg',
                    '/banners/actions/1306374683/1.jpg',
                    '/actions/astra/02092010_5.jpg',
                    '/actions/astra/02092010_6.jpg',
                    '/actions/astra/02092010_7.jpg' ]
        }
        , "price":{
            "discount":"42.-"
            , "regular":"70.-"
            , "percent":"-40%"
            , "benefit":"28.-"
        }, "title":{
            "full":" Tule ja naudi värsket mereõhku. Me ootame Teid Pärnus, väikeses ja hubases Astra hotellis: täna hind kahele – vaid 42 eurot (tavahind on 70 eurot)!"
            , "short":""
        }, "seller":{
            "info":'\n <div class="bl_035">\n\n <table width="100%" border="0" cellpadding="0" cellspacing="0">\n <tr>\n <td valign="top">\n\n <span class="t12">Müüja:\t<img border="0" width="14" align="absmiddle"> <a class="hint_text">astra.ee<span>Vajutage lingile, et saada ammendavat infot sellest partnerist.</span></a></span>\n\n <div class="bl_space"></div>\n\n <u>Firma, organisatsioon:</u> BILAINA OÜ\n\n\n <br>\n <u>www-aadress:</u> <a>www.astra.ee</a>\n\n\n <br><br>\n <a class="iframe_forms"><img border="0" align="absmiddle">Saata kiri e-maili teel</a>\n\n\n <br><br>\n Tammsaare 24-B, Pärnu<br>\n Tel: 4455500\n\n </td>\n\n\n <td align="right" valign="top">\n <a><img align="center" border="0"></a>\t</td>\n\n\n </tr>\n </table>\n\n </div>\n'
        }, "description": {
            "full":'\n\n        Kampaania läbiviimise tingimused.\n        <ul style="margin-bottom: 20px;">\n            <li>Voucher kehtib kahele külastajale. Voucher sisaldab majutust kahekohalises toas, hommikusööki buffee-lauas.  </li>\n            <li>Pikendamaks puhkust, saate korraga kasutada mitut voucherit järjestikusteks öödeks.</li>\n            <li>Antud pakkumise voucherite arv on limiteeritud, soetada on võimalik kuni 30       voucherit.</li>\n            <li>Kui soovite puhata koos lastega, siis lisatasu öö kohta on järgmine: kuni 3a lapsed majutuvad tasuta, lastele vanuses 3-12a (k.a) 15 € ja vanematele kui 15a on lisavoodi 20 € (sisaldades majutust ning hommikusööki). Standard tuppa mahub üks lisavoodi.</li>\n            <li>Pastelsete värvitoonidega tubades on dušš, tualett, TV ning telefon. Parkimine maja ees tasuta. Tasuta traadita internet levib üle kogu hotelli.</li>\n            <li>Lisatasu (40 eur) eest võimalik broneerida sviit (omal valikul kas sauna või mullivanniga). </li>\n            <li>Voucheriga hotelli saunakompleksi (puuküttega saun, infrapunasaun, mullivann, bassein) kasutamine -25% kehtivast hinnakirjast. Et tagada Teile meelepäraseimad ajad, soovitame kellaajad hotelliga eelnevalt kooskõlastada ja broneerida. </li>\n            <li> Astra hotelli klientidele:<br/>\n                - Hotelli restoranis soodustus -20% (v.a joogid).<br/>\n                - Vabapääsmed kahele ööklubisse Mirage.<br/>\n                - Tervise Paradiisi veekeskus – 10%.</li>\n            <li class="red">Palume Teil hotelli külastus eelnevalt ette broneerida telefonil <b>4455500</b> või e-mailil <a href="mailto:info@astra.ee">info@astra.ee</a>.</li>\n            <li class="red">Voucher kehtib 04.08.2012 kuni 31.10.2012.</li></ul>\n\n\n\n        <br/>\n        <br/>\n        <br/>\n        <br/>\n        <br/>\n        <br/>\n        \n\n    '
            , "short":""
            , "map":"http://maps.google.com/maps?f=q&source=s_q&hl=en&geocode=&q=Hotel+Astra%E2%80%8E+&sll=58.376046,24.509726&sspn=0.011139,0.038581&g=Tammsaare+24+P%C3%A4rnu&ie=UTF8&cid=15258611264758587628&hq=Hotel+Astra%E2%80%8E+&hnear=&ll=58.378949,24.505091&spn=0.01575,0.052357&z=14&iwloc=A&output=embed"
        }
    })

    validator('www.living.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.iluveeb.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.hotelliveeb.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.headiil.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.ediilid.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.crazydeal.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.chilli.ee', {
        'pictures':{
            'main':{
                'count':55, 'url':'/upload/4fbf12095606ed671098e1b652dae2c2_1345812070.jpg'
            }, 'other':{
                'count':5, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('www.cherry.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    })

    validator('turismiweb.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('parimadpakkumised.ee', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('missfoxy.eu', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)

    validator('kingakaubamaja', {
        'pictures':{
            'main':{
                'count':67, 'url':'/var/cache/thumb_462x308/8e/66/8e666d60fe8adb460b8bdac522594691.jpg'
            }, 'other':{
                'count':8, 'urls':['http://zizu.ee/sites/default/files/dattach/pannkoogid0828/pannkoogid0828_bottom_ee.jpg']
            }
        }
    }, true)
})